variant: fcos
version: 1.0.0
passwd:
  users:
    - name: jenkins
      uid: 9999 # 1000 is already used by core user
      system: true
      no_create_home: true
      shell: /usr/sbin/nologin
    - name: maintuser
      uid: 1001
      groups:
        - sudo
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC0NK6M/cGCjwEf4jLIN42xBFCUWt+pXRuE+n21YadwqcUHdBn6qv4lyyVFMQ22fzcRGCb5D2yU1+UCiNNEnMFpQxTrqnvzIyhaLJAxtkO24bOk2wG2rLaTLCxJnhInfgRM3BJ/Rom95HAdnGPdw8yqBqtcHndPeKcTBF0eeGPi3EZVb081qdnftPMd45p5M2Zo1x6tbQpQfKeXqm7UF79tZoaIJ1yGEIJhHrAQf/zUgCaYDOXUlnTc9O9g/mIoEXIu21ZawR93h9HZHZvod9gWWvnlouOJBq+YfqvSdVxhmD1xXNkbTn+TZSURo+ne35yVD8rsXWjGwm4y2zE9d+md+C7+vjuwgGBY15Vln2SgL6G+QRcz6kwsFwZrOLI0BwjFhvBOSallvl9rittSwke9Nk+nw9+2HrY/LucgeB6qZUNI5BzTwzfNjBxJVYhcIXcOdem5TBsovpvcBxnNVHOpqiU8wVoNa4P55duCX4CRyV8gsrAVBIk/Y+IrucMR4D/YqJaVBpi3D3xMe3mVj0jMIYQqvRfQkK4Dw04bRKFUjf7drc3rzFu/72QtWaM98t1b1IhMOMNOtiNhploNcGuuSVgDfhnY24RV1sJ8hxjH85YBUNMi6+Z2Et+hiQ88kUaXyapVg6E2KvtLy7DBoNDlEZtxJkzS98Isf2tzQ8mS9w== maintuser@libvirt.local
storage:
  directories:
    - path: /etc/jenkins
      mode: 0750
      user:
        name: jenkins
      group:
        name: root
    - path: /etc/jenkins/plugins
      mode: 0750
      user:
        id: 1000 # Jenkins UID inside container
      group:
        name: root
    - path: /var/lib/jenkins
      mode: 0750
      user:
        name: jenkins
      group:
        name: root
    - path: /var/lib/jenkins/data
      mode: 0750
      user:
        id: 1000 # Jenkins UID inside container
      group:
        name: root
  files:
    - path: /etc/hostname
      overwrite: true
      mode: 0644
      user:
        name: root
      group:
        name: root
      contents:
        inline: jenkins-master.libvirt.local
    - path: /etc/jenkins/plugins.txt
      mode: 0640
      user:
        id: 1000 # Jenkins UID inside container
      group:
        name: root
      contents:
        inline: |
          configuration-as-code:1.38
          simple-theme-plugin:0.6
          ssh-slaves:1.31.1
          pipeline-model-definition:1.6.0
          matrix-auth:2.5
          role-strategy:2.16
          authorize-project:1.3.0
    - path: /etc/jenkins/config.yml
      mode: 0640
      user:
        id: 1000 # Jenkins UID inside container
      group:
        name: root
      contents:
        inline: |
          jenkins:
            systemMessage: "Jenkins configured automatically by Jenkins Configuration as Code plugin\n\n"
            securityRealm:
              local:
                allowsSignup: false
                users:
                  - id: administrator
                    name: Jenkins Administrator
                    password: ${ADMIN_PASSWORD:-f60f8e269a732d67c83bb3f41465ae5a}
                  - id: developer
                    name: Jenkins Developer
                    password: ${DEVELOPER_PASSWORD:-a04c30dda292372faeb9f3d59ed56d36}
            authorizationStrategy:
              globalMatrix:
                grantedPermissions:
                  - Overall/Administer:administrator
                  - Overall/Read:authenticated
            remotingSecurity:
              enabled: true
            nodes:
              - permanent:
                  name: slave-docker
                  labelString: linux rhel x86 docker
                  numExecutors: 5
                  remoteFS: /var/lib/jenkins/agent
                  launcher:
                    ssh:
                      host: jenkins-slave.libvirt.local
                      port: 22
                      credentialsId: ssh_agents_private_key
                      maxNumRetries: 6
                      retryWaitTime: 30
                      sshHostKeyVerificationStrategy:
                        manuallyTrustedKeyVerificationStrategy:
                          requireInitialManualTrust: false
            disabledAdministrativeMonitors:
              - hudson.node_monitors.MonitorMarkedNodeOffline
              - hudson.node_monitors.TemporarySpaceMonitor
              - hudson.node_monitors.DiskSpaceMonitor
          credentials:
            system:
              domainCredentials:
                - credentials:
                    - basicSSHUserPrivateKey:
                        scope: SYSTEM
                        id: ssh_agents_private_key
                        username: jenkins
                        description: "SSH private key to connect to Jenkins agents"
                        privateKeySource:
                          directEntry:
                            privateKey: ${SSH_AGENTS_PRIVATE_KEY}
          unclassified:
            location:
              adminAddress: maintuser@libvirt.local
              url: http://jenkins-master.libvirt.local:8080
            simple-theme-plugin:
              elements:
                - cssUrl:
                    url: https://cdn.rawgit.com/afonsof/jenkins-material-theme/gh-pages/dist/material-blue-grey.css

    - path: /etc/sysconfig/jenkins
      mode: 0640
      user:
        name: root
      group:
        name: root
      contents:
        inline: |
          JENKINS_IMAGE="docker.io/jenkins/jenkins:2.230-centos"
          JENKINS_UID="1000"
          JENKINS_MAX_CPU="1.000"
          JENKINS_MAX_MEMORY="1000m"
          JENKINS_HTTP_PORT="8080"
          JENKINS_EXECUTOR_PORT="50000"
          JENKINS_DATA_PATH="/var/lib/jenkins/data"
          JENKINS_PLUGINS="/etc/jenkins/plugins.txt"
          JENKINS_PLUGINS_PATH="/etc/jenkins/plugins"
          JENKINS_CONFIGURATION="/etc/jenkins/config.yml"
          JENKINS_JAVA_OPTS="\
            -Djenkins.install.runSetupWizard=false \
            -Djava.awt.headless=true \
          "
systemd:
  units:
    - name: jenkins-plugins.service
      enabled: true
      contents: |
        [Unit]
        Description=Download Jenkins plugins
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        EnvironmentFile=/etc/sysconfig/jenkins
        RemainAfterExit=true
        StandardOutput=journal
        ExecStartPre=-/bin/podman pull ${JENKINS_IMAGE}
        ExecStart=/bin/podman run --name %n --rm \
            --user       ${JENKINS_UID} \
            --cpus       ${JENKINS_MAX_CPU} \
            --memory     ${JENKINS_MAX_MEMORY} \
            --volume     ${JENKINS_PLUGINS}:/usr/share/jenkins/ref/plugins.txt:z \
            --volume     ${JENKINS_PLUGINS_PATH}:/usr/share/jenkins/ref/plugins:z \
            --entrypoint /bin/bash \
            ${JENKINS_IMAGE} -c "/usr/local/bin/install-plugins.sh < /usr/share/jenkins/ref/plugins.txt"
        ExecStop=/bin/sh -c '/bin/rm -rf ${JENKINS_PLUGINS}/*'

        [Install]
        WantedBy=multi-user.target
    - name: jenkins.service
      enabled: true
      contents: |
        [Unit]
        Description=Run Jenkins master
        After=network-online.target jenkins-plugins.service
        Wants=network-online.target jenkins-plugins.service

        [Service]
        Type=simple
        EnvironmentFile=/etc/sysconfig/jenkins
        TimeoutStartSec=180
        Restart=always
        StandardOutput=journal
        ExecStartPre=-/bin/podman pull ${JENKINS_IMAGE}
        ExecStart=/bin/podman run --name %n --rm \
            --user    ${JENKINS_UID} \
            --cpus    ${JENKINS_MAX_CPU} \
            --memory  ${JENKINS_MAX_MEMORY} \
            --publish ${JENKINS_HTTP_PORT}:8080 \
            --publish ${JENKINS_EXECUTOR_PORT}:50000 \
            --volume  ${JENKINS_DATA_PATH}:/var/jenkins_home:z \
            --volume  ${JENKINS_PLUGINS_PATH}:/usr/share/jenkins/ref/plugins:z \
            --volume  ${JENKINS_CONFIGURATION}:/var/jenkins_home/jenkins.yaml:z \
            --env     JAVA_OPTS="${JENKINS_JAVA_OPTS}" \
            ${JENKINS_IMAGE}
        ExecStop=/bin/podman stop %n
        ExecReload=/bin/podman restart %n

        [Install]
        WantedBy=multi-user.target